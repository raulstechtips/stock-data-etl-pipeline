---
name: PR Validation

on:
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    # Service container for PostgreSQL - isolated database for tests
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      SECRET_KEY: "test-secret-key-for-ci-only-not-for-production"
      APP_ENV: "test"
      # Database connection for service container
      SQL_DATABASE: "test_db"
      SQL_USER: "test_user"
      SQL_PASSWORD: "test_password"
      SQL_HOST: "localhost"
      SQL_PORT: "5432"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install PostgreSQL system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev
          # Clean up apt cache to reduce image size
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install uv with all available options
        uses: astral-sh/setup-uv@v7
        with:
          version: "0.9.17"
          python-version: "3.12"
          working-directory: "services"

      - name: Install dependencies with UV
        working-directory: ./services
        run: |
          # Create virtual environment and install dependencies from lockfile
          uv venv
          uv sync --frozen --no-dev

      - name: Run migrations
        working-directory: ./services
        run: |
          source .venv/bin/activate
          python manage.py migrate --verbosity=2

      - name: Run API tests
        working-directory: ./services
        run: |
          source .venv/bin/activate
          python manage.py test api.tests --verbosity=2
