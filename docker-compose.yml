---
services:
    web:
        build: ./services
        volumes:
            - ./services:/usr/src/app/
            - ~/.gitconfig:/root/.gitconfig:ro
            - zsh_history_data:/root/.zsh_history
        ports:
            - 8000:8000
        env_file:
            - ./.env
        depends_on:
            - db
            - redis
            - rabbitmq
            - createbuckets
        network_mode: "host"

    worker:
        build: ./services
        volumes:
            - ./services:/usr/src/app/
        env_file:
            - ./.env
        depends_on:
            - db
            - redis
            - rabbitmq
            - minio
            - createbuckets
        network_mode: "host"
        command: ["/usr/src/app/scripts/entrypoint.worker.dev.sh"]

    worker_delta:
        build: ./services
        volumes:
            - ./services:/usr/src/app/
        env_file:
            - ./.env
        depends_on:
            - db
            - redis
            - rabbitmq
            - minio
            - createbuckets
        network_mode: "host"
        command: ["/usr/src/app/scripts/entrypoint.worker.delta.sh"]

    db:
        image: postgres:17.5
        ports:
            - 5432:5432
        volumes:
            - postgres_data:/var/lib/postgresql/data/
        environment:
            - POSTGRES_USER=hello_django
            - POSTGRES_PASSWORD=hello_django
            - POSTGRES_DB=hello_django_dev

    redis:
        image: redis:7-alpine
        ports:
            - 6379:6379
        volumes:
            - redis_data:/data
        command: redis-server --appendonly yes --requirepass hello_django

    rabbitmq:
        image: rabbitmq:4.2-management-alpine
        ports:
            - 5672:5672
            - 15672:15672
        volumes:
            - rabbitmq_data:/var/lib/rabbitmq
        environment:
            - RABBITMQ_DEFAULT_USER=hello_django
            - RABBITMQ_DEFAULT_PASS=hello_django

    minio:
        image: minio/minio:latest
        ports:
            - "8081:8081"
            - "8082:8082"
        environment:
            - MINIO_ROOT_USER=hello_django
            - MINIO_ROOT_PASSWORD=hello_django
            - MINIO_BROWSER_REDIRECT_URL=http://localhost:8082
            - MINIO_SERVER_URL=http://localhost:8081
        volumes:
            - minio_data:/data
        command: server /data --console-address ":8082" --address ":8081"

    createbuckets:
        image: minio/mc:latest
        entrypoint: >
            /bin/sh -c "
            until mc alias set myminio http://minio:8081 hello_django hello_django 2>/dev/null; do
              echo 'Waiting for MinIO to be ready...' && sleep 2;
            done &&
            mc ls myminio/static >/dev/null 2>&1 || mc mb myminio/static &&
            mc ls myminio/media >/dev/null 2>&1 || mc mb myminio/media &&
            mc ls myminio/stock-raw-data >/dev/null 2>&1 || mc mb myminio/stock-raw-data &&
            mc ls myminio/stock-delta-lake >/dev/null 2>&1 || mc mb myminio/stock-delta-lake &&
            mc anonymous set download myminio/static &&
            echo 'Buckets created successfully - static is public, media, stock-raw-data, and stock-delta-lake are private'
            "
        depends_on:
            - minio

volumes:
    zsh_history_data:
    postgres_data:
    redis_data:
    rabbitmq_data:
    minio_data:
