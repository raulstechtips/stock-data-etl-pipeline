<!-- Dropdown Select Component -->
<!-- 
  Reusable dropdown select component that inherits from parent x-data context.
  
  Usage:
  <div x-data="{ 
      options: [],
      selected: '',
      loading: false,
      placeholder: 'Select...',
      onLoad: () => {},
      onChange: (value) => {}
  }">
      { include 'components/shared/dropdown_select.html' }
  </div>
  
  Required parent x-data properties:
  - options: array of objects with {id, name, value?} or array of strings
  - selected: current selected value
  - loading: boolean loading state
  - placeholder: string placeholder text
  - onLoad: function to call when dropdown opens (for lazy loading)
  - onChange: function to call when option is selected (value) => {}
  
  Optional parent x-data properties:
  - loadingText: string for loading message (default: 'Loading...')
  - disabled: boolean to disable dropdown
  - label: string for label (if provided, label is rendered)
-->

<div 
    x-data="{ 
        open: false,
        emptyText: 'No options available',
        loadingText: typeof loadingText !== 'undefined' ? loadingText : 'Loading...',
        init() {
            // Watch for dropdown opening to trigger lazy loading
            this.$watch('open', value => {
                if (value) {
                    // Call onLoad callback if provided (for lazy loading)
                    if (typeof onLoad === 'function') {
                        onLoad();
                    }
                }
            });
        },
        getDisplayText() {
            // If no selection, return placeholder
            if (selected === null || selected === undefined || selected === '') {
                return placeholder || 'Select...';
            }
            // If options is array of objects, find by value
            if (options && options.length > 0 && typeof options[0] === 'object') {
                const option = options.find(opt => {
                    const optValue = opt.value !== undefined ? opt.value : (opt.name || opt.id);
                    return optValue === selected;
                });
                return option ? (option.name || option.value || option.id) : selected;
            }
            // If options is array of strings
            return selected;
        },
        isSelected(value) {
            return selected === value;
        },
        selectOption(value) {
            if (typeof onChange === 'function') {
                onChange(value);
            } else {
                selected = value;
            }
            this.open = false;
        },
        getOptionValue(option) {
            if (typeof option === 'object') {
                // Handle value: can be empty string, null, or undefined
                if (option.value !== undefined && option.value !== null) {
                    return option.value;
                }
                // Fallback to name or id, but allow empty string
                if (option.name !== undefined) {
                    return option.name;
                }
                if (option.id !== undefined) {
                    return option.id;
                }
                return '';
            }
            return option;
        },
        getOptionLabel(option) {
            if (typeof option === 'object') {
                return option.name || option.value || option.id;
            }
            return option;
        }
    }"
    class="relative"
>
    <!-- Label (if provided) -->
    <label 
        x-show="typeof label !== 'undefined' && label"
        class="block text-sm font-medium text-theme-secondary mb-1"
        x-text="label"
    ></label>

    <!-- Dropdown Button -->
    <button
        type="button"
        @click="open = !open"
        :disabled="loading || (typeof disabled !== 'undefined' && disabled)"
        class="w-full px-3 py-2.5 pr-10 text-left border border-theme-primary rounded-lg bg-theme-secondary text-theme-primary focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 disabled:opacity-60 disabled:cursor-wait appearance-none cursor-pointer transition-all duration-200 hover:border-primary-500 shadow-sm relative"
        :aria-label="label || 'Select option'"
        aria-haspopup="listbox"
        :aria-expanded="open"
    >
        <span x-text="getDisplayText()" class="truncate block pr-6"></span>
        <div class="absolute inset-y-0 right-0 flex items-center justify-center pr-3 pointer-events-none">
            <!-- Circular loading spinner -->
            <svg 
                x-show="loading"
                class="animate-spin h-5 w-5 text-info" 
                xmlns="http://www.w3.org/2000/svg" 
                fill="none" 
                viewBox="0 0 24 24"
            >
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <!-- Dropdown arrow -->
            <svg 
                x-show="!loading"
                :class="open ? 'transform rotate-180' : ''"
                class="h-5 w-5 text-theme-secondary transition-transform duration-200 flex-shrink-0" 
                fill="none" 
                stroke="currentColor" 
                viewBox="0 0 24 24"
            >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
    </button>

    <!-- Dropdown Menu -->
    <div
        x-show="open"
        x-cloak
        x-transition:enter="transition ease-out duration-100"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-75"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        @click.away="open = false"
        class="absolute z-50 mt-1 w-full rounded-lg bg-theme-secondary border border-theme-primary shadow-lg max-h-60 overflow-auto"
        role="listbox"
    >
        <!-- Loading State -->
        <div x-show="loading" class="px-3 py-4 text-center">
            <div class="flex flex-col items-center gap-2">
                <svg class="animate-spin h-6 w-6 text-info" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-sm text-theme-secondary" x-text="loadingText"></p>
            </div>
        </div>

        <!-- Empty State -->
        <div x-show="!loading && (!options || options.length === 0)" class="px-4 py-3 text-center">
            <p class="text-sm text-theme-secondary" x-text="emptyText"></p>
        </div>

        <!-- Options -->
        <div x-show="!loading && options && options.length > 0">
            <!-- Options List -->
            <template x-for="(option, idx) in options" :key="getOptionValue(option) + '-' + idx">
                <button
                    type="button"
                    @click="selectOption(getOptionValue(option))"
                    :class="isSelected(getOptionValue(option)) ? 'bg-primary-500 text-white' : 'text-theme-primary hover:bg-theme-tertiary'"
                    class="w-full px-4 py-2.5 text-left text-sm transition-colors duration-150 first:rounded-t-lg last:rounded-b-lg"
                    role="option"
                    :aria-selected="isSelected(getOptionValue(option))"
                >
                    <span class="flex items-center">
                        <span x-text="getOptionLabel(option)"></span>
                        <svg 
                            x-show="isSelected(getOptionValue(option))" 
                            class="ml-auto h-4 w-4" 
                            fill="currentColor" 
                            viewBox="0 0 20 20"
                        >
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </span>
                </button>
            </template>
        </div>
    </div>
</div>

